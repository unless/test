name: ğŸ’¿ St0_test
permissions:
  contents: write
  actions: write
  pull-requests: write
  packages: write
on:
  schedule:
    # æ³¨æ„ï¼šGitHub Actions ä½¿ç”¨ UTC æ—¶é—´
    # åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹å¯¹åº” UTC æ—¶é—´çš„ 17ç‚¹ï¼ˆå‰ä¸€å¤©ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'static'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.111.1'
      openwrt_board:
        description: "è¯·é€‰æ‹©è®¾å¤‡å‹å·ï¼ˆé»˜è®¤å½“ä¸‹å¸¸è§è®¾å¤‡ï¼‰"
        required: true
        default: "beikeyun"
        type: choice
        options:
          - beikeyun
          - wxy-oect
          - beikeyun_wxy-oect

env:
  VERSION: '24.10.3'

jobs:
  trigger-st0:
    name: '[ST0] åŒæ­¥ iStoreOS é•œåƒ'
    runs-on: ubuntu-22.04
    outputs:
      # å®šä¹‰è¾“å‡ºï¼Œä¾›åç»­ä»»åŠ¡ä½¿ç”¨
      server_date: ${{ steps.sync-ib.outputs.server_date }}
      should_update: ${{ steps.sync-ib.outputs.should_update }}
      file_name: ${{ steps.sync-ib.outputs.file_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: åŒæ­¥iStoreOSé•œåƒ
        id: sync-ib
        run: |
          set -euo pipefail  # å¯ç”¨ä¸¥æ ¼é”™è¯¯å¤„ç†
          ISURL="https://fw0.koolcenter.com/iStoreOS/ib/armsr"
          ISFILE="istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          TAG="istoreos-imagebuilder-armsr-armv8"
          # è·å–æœåŠ¡å™¨ä¸Šçš„æœ€æ–°æ—¥æœŸ
          SERVER_DATE=$(curl -s -L "$ISURL" | grep -A1 "$TAG" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1) || exit 1
          FILE_NAME="$TAG-$SERVER_DATE.tar.zst"
          echo "è·å–åˆ°çš„æœåŠ¡å™¨æ—¥æœŸ: $SERVER_DATE"
          echo "ç›®æ ‡æ–‡ä»¶å: $FILE_NAME"
          # æ£€æŸ¥GitHub Releaseä¸­æ˜¯å¦å·²å­˜åœ¨æ­¤ç‰ˆæœ¬
          if RELEASE_INFO=$(curl -f -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG") && \
            echo "$RELEASE_INFO" | grep -q "\"name\":.*$FILE_NAME"; then
            echo "âœ… ç‰ˆæœ¬ $TAG ($SERVER_DATE) å·²å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            echo "should_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ éœ€è¦ä¸‹è½½æ–°ç‰ˆæœ¬: $FILE_NAME"
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "server_date=$SERVER_DATE" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          
      - name: ğŸ“ æ·»åŠ æ–°ç‰ˆæœ¬å·
        if: steps.sync-ib.outputs.should_update == 'true'
        run: |
          ST1_FILE=".github/workflows/St1_Build-Rootfs-release.yml"
          SERVER_DATE="${{ steps.sync-ib.outputs.server_date }}"
          
          echo "æ£€æŸ¥æ–‡ä»¶: $ST1_FILE"
          echo "è¦æ·»åŠ çš„æ—¥æœŸ: $SERVER_DATE"
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          if grep -q " - '$SERVER_DATE'" "$ST1_FILE"; then
              echo "é€‰é¡¹å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹"
              exit 0
          fi
          
          # ä½¿ç”¨ç®€å•çš„ sed å‘½ä»¤æ’å…¥æ–°é€‰é¡¹
          sed -i "/ - 'new'/a\          - '$SERVER_DATE'" "$ST1_FILE"
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸæ·»åŠ 
          if grep -q " - '$SERVER_DATE'" "$ST1_FILE"; then
              echo "âœ… ä¿®æ”¹æˆåŠŸ"
          else
              echo "âŒ ä¿®æ”¹å¤±è´¥"
              exit 1
          fi
      
      - name: ğŸ”„ æäº¤å˜æ›´
        if: steps.sync-ib.outputs.should_update == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Actions
          author_email: actions@github.com
          message: "è‡ªåŠ¨æ·»åŠ æ–°ç‰ˆæœ¬é€‰é¡¹: ${{ steps.sync-ib.outputs.server_date }} [skip ci]"
          add: ".github/workflows/St1_Build-Rootfs-release.yml"
          token: ${{ secrets.GITHUB_TOKEN }}
