name: ğŸ’¿ St0_update-Rootfs

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'static'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.111.1'
      openwrt_board:
        description: "è¯·é€‰æ‹©è®¾å¤‡å‹å·ï¼ˆé»˜è®¤å½“ä¸‹å¸¸è§è®¾å¤‡ï¼‰"
        required: true
        default: "beikeyun"
        type: choice
        options:
          - beikeyun
          - wxy-oect
          - beikeyun_wxy-oect

env:
  VERSION: '24.10.3'

jobs:
  trigger-st0:
    name: '[ST0] åŒæ­¥ iStoreOS é•œåƒ'
    runs-on: ubuntu-22.04
    outputs:
      server_date: ${{ steps.sync-ib.outputs.server_date }}
      should_update: ${{ steps.sync-ib.outputs.should_update }}
      file_name: ${{ steps.sync-ib.outputs.file_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}  # æ·»åŠ å†™æƒé™token
          ref: main

      - name: åŒæ­¥iStoreOSé•œåƒ
        id: sync-ib
        run: |
          set -euo pipefail

          ISURL="https://fw0.koolcenter.com/iStoreOS/ib/armsr"
          ISFILE="istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          TAG="istoreos-imagebuilder-armsr-armv8"

          SERVER_DATE=$(curl -s -L "$ISURL" | grep -A1 "$TAG" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1) || exit 1
          FILE_NAME="$TAG-$SERVER_DATE.tar.zst"

          echo "è·å–åˆ°çš„æœåŠ¡å™¨æ—¥æœŸ: $SERVER_DATE"
          echo "ç›®æ ‡æ–‡ä»¶å: $FILE_NAME"

          if RELEASE_INFO=$(curl -f -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG") && \
            echo "$RELEASE_INFO" | grep -q "\"name\":.*$FILE_NAME"; then
            echo "âœ… ç‰ˆæœ¬ $TAG ($SERVER_DATE) å·²å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            echo "should_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ éœ€è¦ä¸‹è½½æ–°ç‰ˆæœ¬: $FILE_NAME"
            curl -L -o "$FILE_NAME" "$ISURL/$ISFILE"
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi

          echo "server_date=$SERVER_DATE" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT

      # æ·»åŠ æ–°æ—¥æœŸé€‰é¡¹åˆ°å·¥ä½œæµæ–‡ä»¶
      - name: æ›´æ–°å·¥ä½œæµé€‰é¡¹
        if: steps.sync-ib.outputs.should_update == 'true'
        run: |
          # è·å–å½“å‰æ—¥æœŸï¼ˆæ ¼å¼ï¼š2025-10-19ï¼‰
          SERVER_DATE="${{ steps.sync-ib.outputs.server_date }}"
          
          # åœ¨'new'é€‰é¡¹ä¸‹æ–¹æ·»åŠ æ–°æ—¥æœŸ
          sed -i "/- 'new'/a \          - '$SERVER_DATE'" .github/workflows/St1_Build-Rootfs-release.yml
          
          # æäº¤æ›´æ”¹
          git config user.name "github-actions"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/St1_Build-Rootfs-release.yml
          git commit -m "æ·»åŠ æ–°ç‰ˆæœ¬é€‰é¡¹: $dangqianshijian"
          git push origin main

      - name: ğŸš€ ä¸Šä¼ åˆ° Release (å¦‚éœ€è¦)
        if: steps.sync-ib.outputs.should_update == 'true'
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: istoreos-imagebuilder-armsr-armv8
          body: |
            ğŸ“… åŒæ­¥ç‰ˆæœ¬: ${{ steps.sync-ib.outputs.server_date }}
            âš™ï¸ è§¦å‘æäº¤: ${{ github.sha }}
          files: |
            ${{ steps.sync-ib.outputs.file_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}


